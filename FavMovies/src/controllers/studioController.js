const Studio = require('../models/studio')
const mongoose = require('mongoose')
const jwt = require('jsonwebtoken')
require('dotenv').config()

const getAllStudio = async (req, res) => {
    const authHeader = req.get('authorization');
    const token = authHeader.split(' ')[1]
  
    if (!token) {
      return res.status(403).send({message: "Kd a tokenzinnn"})
    }
    jwt.verify(token, process.env.SECRET, async (err) => {
      if (err) {
        res.status(403).send({ message: 'Token não válido', err})
      }
  
      const studio = await Studio.find()
      res.json(studio)
    })
  }

const getStudioById = async (req,res) => {
    const authHeader = req.get('authorization');
    const token = authHeader.split(' ')[1]
  
    if (!token) {
      return res.status(403).send({message: "Kd a tokenzinnn"})
    }
    jwt.verify(token, process.env.SECRET, async (err) => {
      if (err) {
        res.status(403).send({ message: 'Token não válido', err})
      }
        const requestId = req.params.id
        const StudiosById = await Studio.findOne({ _id: requestId })
        res.json(StudiosById)
    })
}

const createStudio = async (req,res) => {
    const studios = new Studio({
      _id: new mongoose.Types.ObjectId(),
      name: req.body.name,
      createAt: req.body.createAt
    })

    const allStudiosValidation = await Studio.findOne({ name: req.body.name })
    
    if (allStudiosValidation) {
        res.status(409).json({error: `Studio ${req.body.name} is already registered`})
    } else {
        try{
            const newStudio = await studios.save()
            res.status(201).json(newStudio)
        } catch(err){
            res.status(400).json({ message: err.message })
        }
    }
}

const deleteStudio = async (req,res) => {
    const requestId = req.params.id

    const StudiosValidation = await Studio.findOne({ _id: requestId })
    
    if (!StudiosValidation) {
        res.status(409).json({error: `Studio does not exist`})
    } else { 
        try{
            Studio.remove({ _id: requestId }, function(err) {
                if (!err) {
                    res.status(200).json({ message: "Successfully deleted :3"})
                }
                else {
                    res.status(400).json({ message: err.message })
                }
            })
        } catch (err) {
            res.status(400).json({ message: err.message })
        }
    }
}

const updateStudio = async (req,res) => {
    try {
        const studio = await Studio.findById(req.params.id)

        if (studio == null) {
          return res.status(404).json({message: "studio not found"})
        }

        if (req.body.name != null) {
            studio.name = req.body.name
        }

        const studioAtualizado = await studio.save()
        res.status(200).json(studioAtualizado)
    
      } catch (err) {
        res.status(500).json({message: err.message})
      }
    }

module.exports = {
    getAllStudio,
    getStudioById,
    createStudio,
    deleteStudio,
    updateStudio
}